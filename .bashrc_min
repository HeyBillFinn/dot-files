set -o vi
export EDITOR=vim

PERSISTENT_HISTORY_FILE="$HOME/dot-files/.persistent_history"
HISTTIMEFORMAT="%F %T "
log_bash_persistent_history()
{
  [[
  $(history 1) =~ ^\ *[0-9]+\ +([^\ ]+\ [^\ ]+)\ +(.*)$
  ]]
  local date_part="${BASH_REMATCH[1]}"
  local command_part="${BASH_REMATCH[2]}"
  if [ "$command_part" != "$PERSISTENT_HISTORY_LAST" ] && \
    [[ $command_part != "phgrep "* ]]
  then
    if [[ $command_part == "ph "* ]]
    then
      parsed_command=$(echo $command_part | awk '{print $2}')
      command_part=$(_ph_get_command $parsed_command)
    fi
    echo $date_part "|" $HOSTNAME "|" $PWD "|" "$command_part" >> $PERSISTENT_HISTORY_FILE
    export PERSISTENT_HISTORY_LAST="$command_part"
  fi
}

# Stuff to do on PROMPT_COMMAND
run_on_prompt_command()
{
  log_bash_persistent_history
}

_ph_get_command()
{
  if [ "$#" -ne 1 ]; then
    echo "Illegal number of parameters"
  else
    if ! [[ $1 =~ ^-?[0-9]+$ ]]; then
      echo "Illegal non-integer argument."
    else
      command=`sed "$1!d" $PERSISTENT_HISTORY_FILE | awk -F "|" '{print $4}'`
      echo $command
    fi
  fi
}

ph()
{
  if [ "$#" -ne 1 ]; then
    echo "Illegal number of parameters"
  else
    command=$(_ph_get_command $1)
    echo $command
    eval $command
  fi
}

phe()
{
  if [ "$#" -ne 1 ]; then
    echo "Illegal number of parameters"
  else
    command=$(_ph_get_command $1)
    echo $command
  fi
}

alias nt='nosetests -s --with-progressive'

PROMPT_COMMAND="run_on_prompt_command"
#  \*(Ps = \*3\*0 \(-> Set foreground color to Black.
#  \*(Ps = \*3\*1 \(-> Set foreground color to Red.
#  \*(Ps = \*3\*2 \(-> Set foreground color to Green.
#  \*(Ps = \*3\*3 \(-> Set foreground color to Yellow.
#  \*(Ps = \*3\*4 \(-> Set foreground color to Blue.
#  \*(Ps = \*3\*5 \(-> Set foreground color to Magenta.
#  \*(Ps = \*3\*6 \(-> Set foreground color to Cyan.
#  \*(Ps = \*3\*7 \(-> Set foreground color to White.
#  \*(Ps = \*3\*9 \(-> Set foreground color to default (original).
#  \*(Ps = \*4\*0 \(-> Set background color to Black.
#  \*(Ps = \*4\*1 \(-> Set background color to Red.
#  \*(Ps = \*4\*2 \(-> Set background color to Green.
#  \*(Ps = \*4\*3 \(-> Set background color to Yellow.
#  \*(Ps = \*4\*4 \(-> Set background color to Blue.
#  \*(Ps = \*4\*5 \(-> Set background color to Magenta.
#  \*(Ps = \*4\*6 \(-> Set background color to Cyan.
#  \*(Ps = \*4\*7 \(-> Set background color to White.
#  \*(Ps = \*4\*9 \(-> Set background color to default (original).

if [[ $HOSTNAME == "vagrant"* ]]
then
  PS1="\[\033[37m\]\t\[\033[m\]-\[\033[36m\]\u\[\033[m\]@\[\033[32m\]\h:\[\033[33;1m\]\w\[\033[m\]\$ "
fi
alias phgrep='cat $PERSISTENT_HISTORY_FILE|grep --color -n'
alias ag='ack-grep --ignore-dir dist'
alias agt='find . -name "*.py" -type f | xargs ls -tr1 | xargs ag '
alias k='fc -s'
alias gchrome='google-chrome --high-dpi-support=1 --force-device-scale-factor=1 > /dev/null 2>&1 &'
bind "set completion-ignore-case on"
bind "set show-all-if-ambiguous on"

alias gpush='git push -u origin HEAD'
alias gmaster='git checkout master && git pull'
alias grebase='git checkout master && git pull && git checkout - && git rebase master'
alias gamend='git commit --amend --no-edit'
alias src='source ~/.bashrc'
# Consider using --jobs or --single-transaction or setting the maintenance memory higher
alias pgrestoreprodsnapshot='dropdb za_prod_snapshot; createdb za_prod_snapshot && pg_restore --no-acl --no-owner -d za_prod_snapshot `ls -1t *.dump | head -n 1`'
# alias pgrestoreschemaonly='dropdb za_prod_schema; createdb za_prod_schema && pg_restore --schema-only --no-acl --no-owner -d za_prod_schema `ls -1t *.dump | head -n 1` && pg_restore --table=alembic_version --data-only --no-acl --no-owner -d za_prod_schema `ls -1t *.dump | head -n 1`'
alias prodsnapshot='fab world_db_snapshot:production,restore_to=za_prod_snapshot'
alias proddb='export ZA_PROD_DATABASE_URI=`heroku config:get DATABASE_URL --app=angaza-production`'
#alias sshprod='ec2-ssh `fab group_list_all | grep production__biz | cut -d '"'"' '"'"' -f 1`'
alias sshprod='ec2-ssh `fab group_list_all:production | grep "^production__biz" | awk "{print $1}"`'
alias scpprod='ec2-host `fab group_list_all:production | grep "^production__biz" | awk "{print $1}"`'
alias f8='flake8 --show-source --show-pep8 --config=flake8.ini za'
alias vssh='vagrant ssh'
alias api='ZA_CELERY_BROKER_URL=amqp://guest@localhost:5672 DATABASE_URI=postgres:///za_prod_snapshot za-serve-gunicorn biz_api:/api'
alias apidemo='DATABASE_URI=postgres:///za_sandbox; za-serve-gunicorn biz_api:/api'
alias celerydemo='celery purge -f && AWS_ACCESS_KEY_ID=`cat ~/Projects/Angaza/variables.deploy/AWS_ACCESS_KEY_ID` AWS_SECRET_ACCESS_KEY=`cat ~/Projects/Angaza/variables.deploy/AWS_SECRET_ACCESS_KEY` DATABASE_URI=postgres:///za_sandbox celery --app=za worker --loglevel=INFO --concurrency=1 -Q celery,batch 2>&1 | tee ~/celery.log'
alias celeryprodbeat='ZA_CELERY_BROKER_URL=amqp://guest@localhost:5672 DATABASE_URI=postgres:///za_prod_snapshot celery --app=za beat --loglevel=INFO'
alias zapsqlsnapshot='za-psql -u bill@angazadesign.com -p asdfg postgres:///za_prod_snapshot'
alias zs='za-psql -u bill@angazadesign.com -p asdfg postgres:///za_prod_snapshot -s '
alias utcdate='date -u +%Y%m%dT%H%M%SZ'
alias isodate='date -u +%Y-%m-%dT%H:%M:%SZ'
alias justdate='date +%Y-%m-%d'
alias filenamedate='date +%Y-%m-%d_%H%M%SZ'
stty -ixon
export VIRTUAL_ENV_DISABLE_PROMPT=1

celeryprod()
{
  if [ "$#" -ne 1 ]; then
    echo "Illegal number of parameters"
  else
    echo "rabbitmqadmin purge queue name=$1; celery purge -f && ZA_CELERY_BROKER_URL=amqp://guest@localhost:5672 DATABASE_URI=postgres:///za_prod_snapshot celery --app=za worker --hostname=$1 --loglevel=INFO --concurrency=1 --queues=$1 2>&1 | tee ~/celery_$1.log"
    rabbitmqadmin purge queue name=$1; celery purge -f && ZA_CELERY_BROKER_URL=amqp://guest@localhost:5672 DATABASE_URI=postgres:///za_prod_snapshot celery --app=za worker --hostname=$1 --loglevel=INFO --concurrency=1 --queues=$1 2>&1 | tee ~/celery_$1.log
  fi
}

# set PATH so it includes user's private bin if it exists
if [ -d "$HOME/bin" ] ; then
    PATH="$HOME/bin:$PATH"
fi
shopt -s autocd
export CDPATH=.:~:~/Projects/Angaza
